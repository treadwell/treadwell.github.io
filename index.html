<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=0.86, maximum-scale=3.0, minimum-scale=0.86">
        <title>Breathing Timer</title>
        <script>
            // destructure say args
            // add tts preload to avoid change in voice
            // add scaling visuals
            // add Sury A in tts
            // make responsive - done

            window.onload = () => {
                document.getElementById('notImplemented').setAttribute('onclick','notImplemented()')
            }

            function say({
                    voice = 10,
                    voiceURI = "native", 
                    volume = 0.5,
                    rate = 1.0,
                    pitch = 0.8,
                    m = "Hello world.",
                    lang = "en-US"
                }) {
                    var voices = window.speechSynthesis.getVoices();
                    speechSynthesis.speak(Object.assign(new SpeechSynthesisUtterance(), {
                        voice: voices[voice],  // en has 1, 10, 17
                        voiceURI: voiceURI,
                        volume: document.getElementById("volSlide").value,
                        rate: rate,
                        pitch: pitch,
                        text: m,
                        lang: lang
                }))
            }
            
            // if you have another AudioContext class use that one, as some browsers have a limit
            var audioCtx = new (window.AudioContext || window.webkitAudioContext || window.audioContext);
            
            function beep({
                duration = 500, //duration of the tone in milliseconds. Default is 500
                frequency = 500, //frequency of the tone in hertz. default is 440
                volume = 0.5, //volume of the tone. Default is 1, off is 0.
                type = "triangle", //type of tone. Possible values are sine, square, sawtooth, triangle, and custom. Default is sine.
                callback = () => console.log("callback test") //callback to use on end of tone
            }) {
                var oscillator = audioCtx.createOscillator()
                var gainNode = audioCtx.createGain()

                gainNode.connect(audioCtx.destination)
                gainNode.gain.value = volume

                oscillator.connect(gainNode)
                oscillator.frequency.value = frequency
                oscillator.type = type
                oscillator.onended = callback
                oscillator.start()

                setTimeout(() => oscillator.stop(), duration)
            }
            
            function notImplemented() {
                console.log("feature not implemented")
                document.getElementById('msg').innerHTML = "Feature not implemented."
            }

            function command(message) {
                const playTone = document.getElementById("tones").checked
                const playVoice = document.getElementById("voice").checked
                const volume = document.getElementById("volSlide").value

                document.getElementById('txt').innerHTML = message

                if (playTone) {
                    if (message === "inhale") {
                        beep({ frequency: 1000, volume: volume })
                    } else {
                        beep({ volume: volume })
                    }
                }

                if (playVoice) {
                    if (message === "inhale") {
                        say({ m: "Inhale." })
                    } else {
                        say({ m: "Exhale." })
                    }
                }
            }

            // Destructuring example:
            //      const test = { a: 1, c: [1, 2, 3], d: () => 4 }
            //      let mike = test.b
            //      let { c: [jake, cindy, kara, kenneth = 4] } = test
            //      let { c: matt } = test
            //      console.log(mike, jake, cindy, kara)

            function breathe() {
                // change bpm to seconds and inhale / exhale cycles
                const bpm = document.getElementById("bpm").value
                const duration = document.getElementById("duration").value

                const cycle = 60.0 / bpm * 1000; // ms for a full breath cycle
                const duration_ms = duration * 60 * 1000

                const timers = []  // create separate inhale and exhale timers

                // initiate breathing before setInterval kicks in
                setTimeout(() => command("inhale"), 0)
                setTimeout(() => command("exhale"), cycle / 2)

                // inhale timer on cycle
                timers[0] = setInterval(() => command("inhale"), cycle)

                setTimeout(() => {  // delays exhale timer by half a cycle

                    // exhale timer
                    timers[1] = setInterval(() => command("exhale"), cycle)
                    
                    // clear timers.  
                    // Position here to make sure there are available timer IDs
                    setTimeout(() => {
                        clearInterval(timers[0])
                        clearInterval(timers[1])
                    }, duration_ms)

                }, cycle / 2)

            }

            function readAloud() {
                let lines = document.getElementById('suryA').innerText.split('\n\n')

                for(var i = 0;i < lines.length;i++){
                    // call say() on the html
                    // with a timeout
                    let msg = lines[i]
                    
                    // This doesn't delay, but does say the words
                    // setTimeout(say({ m: msg }), 3000 * i)

                    setTimeout(() => say({ m: msg }), 6000 * i)

                    // The following works with the timeout:
                    // setTimeout(() => {
                    //     console.log(msg)
                    // }, 3000 * i)
                }
            }


        </script>
    </head>
    <body>
        <div id="msg"></div>
        <div id="txt"></div>
        <div id="timer">
            <p>Breaths per minute (count): <input type="number" id="bpm" value="20"></p>
            <p>Length of practice (minutes): <input type="number" id="duration" value="20"></p>
            <p><input type="checkbox" id="tones"> Play tones</p>
            <p><input type="checkbox" id="voice"> Voice synthesis</p>
            <p><input type="range" min="0.0" max="1.0" step="0.01" value="0.5" class="slider" id="volSlide"> Volume</p>
            <p>
                <button onclick="breathe()">Start timer</button>
                <button onclick="window.location.reload()">Reset timer</button>
            </p>
        </div>
        <div id="testRgion">
            <hr/>
            <h3>Test features:</h3>
            <p><button onclick="say({ m: 'ekam, dve, trini.', voice: 20, lang: 'sa' })">TTS</button></p>
            <p><button id="notImplemented">Test feature</button></p>
        </div>
        <div id="suryA">
            <hr/>
            <h3>Surya Namaskara A</h3>
            <p>ekam: inhale, lift the arms up.</p>
            <p>dve: exhale, fold forward.</p>
            <p>trini: inhale, head up only.</p>
            <p>catvari: exhale, jump back to chaturanga.</p>
            <p>panca: inhale, push up to upward dog.</p>
            <p>sat: exhale, push back to downward dog.</p>
            <p>One. Inhale</p>
            <p>Exhale</p>
            <p>Two. Inhale</p>
            <p>Exhale</p>
            <p>Three. Inhale</p>
            <p>Exhale</p>
            <p>Four. Inhale</p>
            <p>Exhale</p>
            <p>Five. Inhale</p>
            <p>Exhale</p>
            <p>sapta: inhale, jump forward, head up.</p>
            <p>astau: exhale, fold forward.</p>
            <p>nava: inhale, lift the arms up.</p>
            <p>Exhale: samasthitih</p>
            
        </div>
        <p><button id="ReadAloud"  onclick="readAloud()">Read aloud</button></p>
    </body>
</html>