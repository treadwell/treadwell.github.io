<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=0.86, maximum-scale=3.0, minimum-scale=0.86">
        <title>Breathing Timer</title>
        <script>
            // add "reset timer" button
            // add scaling visuals
            // add tts preload to avoid change in voice
            // add Sury A in tts
            // make responsive

            function say(m) {
                var msg = new SpeechSynthesisUtterance();
                var voices = window.speechSynthesis.getVoices();
                msg.voice = voices[10];
                msg.voiceURI = "native";
                msg.volume = 1;
                msg.rate = 0.5;
                msg.pitch = 0.8;
                msg.text = m;
                msg.lang = 'en-US';
                speechSynthesis.speak(msg);
            }
            

            // if you have another AudioContext class use that one, as some browsers have a limit
            var audioCtx = new (window.AudioContext || window.webkitAudioContext || window.audioContext);

            //All arguments are optional:

            //duration of the tone in milliseconds. Default is 500
            //frequency of the tone in hertz. default is 440
            //volume of the tone. Default is 1, off is 0.
            //type of tone. Possible values are sine, square, sawtooth, triangle, and custom. Default is sine.
            //callback to use on end of tone
            function beep(duration, frequency, volume, type, callback) {
                // const duration = document.getElementById("tone_length").value
                // const frequency = document.getElementById("tone_freq").value
                // const volume = document.getElementById("tone_volume").value
                // const type = document.getElementById("tone_type").value
                // const callback = "oneended"

                var oscillator = audioCtx.createOscillator();
                var gainNode = audioCtx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                if (volume){gainNode.gain.value = volume;};
                if (frequency){oscillator.frequency.value = frequency;}
                if (type){oscillator.type = type;}
                if (callback){oscillator.onended = callback;}

                oscillator.start();
                setTimeout(function(){oscillator.stop()}, (duration ? duration : 500));
            };

            function notImplemented() {
                console.log("feature not implemented")
                document.getElementById('msg').innerHTML = "Feature not implemented."
            }

            function command(message) {
                const play_tone = document.getElementById("tones").checked ? true : false
                const play_voice = document.getElementById("voice").checked ? true : false
                var volume = document.getElementById("volSlide").value
                // console.log(message)
                // console.log(play_tone)
                console.log (volume)

                document.getElementById('txt').innerHTML = message;

                if (play_tone) {
                    if (message === "inhale") {
                        beep(500, 1000, volume, 'triangle')
                    } else {
                        beep(500, 500, volume, 'triangle')
                    }
                }

                if (play_voice) {
                    if (message === "inhale") {
                        say("Inhale.")
                    } else {
                        say("Exhale.")
                    }
                }
            }

            function breathe() {
                // change bpm to seconds and inhale / exhale cycles
                const bpm = document.getElementById("bpm").value
                const duration = document.getElementById("duration").value

                const cycle = 60.0 / bpm * 1000; // ms for a full breath cycle
                const duration_ms = duration * 60 * 100

                const timers = []  // creating separate inhale and exhale timers

                // initiate breathing before setInterval kicks in
                setTimeout(() => command("inhale"), 0)
                setTimeout(() => command("exhale"), cycle / 2)

                // inhale timer on cycle
                timers[0] = setInterval(() => command("inhale"), cycle)

                setTimeout(() => {  // delays exhale timer by half a cycle

                    // exhale timer
                    timers[1] = setInterval(() => command("exhale"), cycle)
                    
                    // clear timers.  
                    // Position here to make sure there are available timer IDs
                    setTimeout(() => {
                        clearInterval(timers[0])
                        clearInterval(timers[1])
                    }, duration_ms)

                }, cycle / 2)

            }
        </script>
    </head>
    <body>
            <div id="msg"></div>
            <div id="txt"></div>
        <div>
            <p>Breaths per minute (count): <input type="number" id="bpm" value="6"></p>
            <p>Length of practice (minutes): <input type="number" id="duration" value="20"></p>
            <p><input type="checkbox" id="tones"> Play tones</p>
            <p><input type="checkbox" id="voice"> Voice synthesis</p>
            <p><input type="range" min="0.0" max="1.0" step="0.01" value="0.5" class="slider" id="volSlide"> Volume</p>
            <p>
                <button onclick="breathe()">Start timer</button>
            </p>
            <p><button onclick="say('Hello world.')">TTS</button></p>
            <p><button onclick="notImplemented()">Test feature</button></p>
        </div>
    </body>
</html>